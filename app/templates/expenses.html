{% extends "base.html" %}

{% block title %}{{ category.name }} Expenses | SmartSpend{% endblock title %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 align-items-end">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ category.name }}</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-0 text-dark">{{ category.name }}</h1>
            <p class="text-muted mb-0">Detailed transaction history for this category.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{{ url_for('main.add_expense', id=category.id) }}" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold">
                <i class="bi bi-plus-lg me-2"></i>Add Expense
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 border-0 text-uppercase small fw-bold text-muted">Date</th>
                            <th class="border-0 text-uppercase small fw-bold text-muted">Description</th>
                            <th class="border-0 text-end text-uppercase small fw-bold text-muted">Amount</th>
                            <th class="border-0 text-center pe-4 text-uppercase small fw-bold text-muted" style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set displayed = namespace(found=false) %}
                        {% for expense in expenses %}
                            {% if category.id == expense.category_id %}
                                {% set displayed.found = true %}
                                <tr>
                                    <td class="ps-4 text-secondary small">
                                        {{ expense.created_at.strftime('%b %d, %Y') if expense.created_at else 'N/A' }}
                                    </td>
                                    <td class="fw-medium text-dark">
                                        {{ expense.description if expense.description else 'General Expense' }}
                                    </td>
                                    <td class="text-end fw-bold text-primary">
                                        ₱{{ "{:,.2f}".format(expense.amount) }}
                                    </td>
                                    <td class="text-center pe-4">
                                        <div class="d-flex justify-content-center gap-2">
                                            <a href="{{ url_for('main.edit_expense', category_id=category.id, expense_id=expense.id) }}" 
                                               class="btn btn-sm btn-outline-primary border-0 rounded-3" 
                                               title="Edit Expense">
                                                <i class="bi bi-pencil-square fs-5"></i>
                                            </a>
                                            
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger border-0 rounded-3" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteModal{{ expense.id }}"
                                                    title="Delete Expense">
                                                <i class="bi bi-trash3 fs-5"></i>
                                            </button>
                                        </div>

                                        <div class="modal fade" id="deleteModal{{ expense.id }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered modal-sm">
                                                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.2rem;">
                                                    <div class="modal-header border-0 pt-3 pe-3">
                                                        <button type="button" class="btn-close btn-close-red ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body text-center pt-0 pb-4">
                                                        <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                            <i class="bi bi-trash3 fs-3"></i>
                                                        </div>
                                                        <h6 class="fw-bold text-dark mb-2">Delete Expense?</h6>
                                                        <p class="text-muted small mb-0 px-3">Are you sure you want to remove <strong>₱{{ "{:,.2f}".format(expense.amount) }}</strong> from your records?</p>
                                                    </div>
                                                    <div class="modal-footer border-0 p-3 pt-0 d-flex justify-content-center">
                                                        <form method="post" action="{{ url_for('main.delete_expense', category_id=category.id, expense_id=expense.id) }}" class="w-100 px-3">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold py-2 shadow-sm">Confirm Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}

                        {% if not displayed.found %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-receipt-cutoff fs-1 text-light mb-3 d-block"></i>
                                    <p class="text-muted mb-0">No expenses found in <strong>{{ category.name }}</strong>.</p>
                                    <small class="text-secondary">Click "Add Expense" to get started.</small>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-link text-decoration-none text-muted small">
            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

<style>
    .btn-close-red {
        filter: invert(27%) sepia(91%) saturate(6144%) hue-rotate(346deg) brightness(104%) contrast(107%);
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }
    .btn-close-red:hover { opacity: 1; }


    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.02);
    }
    
    .btn-sm { transition: all 0.2s ease; }
    .btn-sm:hover { transform: scale(1.1); }
</style>
{% endblock content %}